@startuml cicd-flow
!include _standard-style.puml

title CI/CD Deployment Flow (SST v3)

|Developer|
start
:Push Code;

|GitHub|
if (Branch?) then (develop)
    :Trigger Deploy Workflow;
    :Stage = dev;
else if (Branch?) then (main)
    :Trigger Deploy Workflow;
    :Stage = int;
else (tag v*)
    :Trigger Deploy Workflow;
    :Stage = prod;
endif

|GitHub Actions|
:Checkout Code;
:Setup Node.js 20;
:Install Dependencies;

:Read Version from package.json;
note right
  npm_package_version
  e.g., "1.0.5"
end note

:SST Deploy;
note right
  npx sst deploy --stage $STAGE

  SST handles:
  - Cognito User Pool
  - Lambda Function URL
  - S3 Static Site
  - CloudFront CDN
  - Environment injection
end note

:Build Frontend;
note right
  SST injects at build time:
  - VITE_API_URL
  - VITE_COGNITO_USER_POOL_ID
  - VITE_COGNITO_USER_POOL_CLIENT_ID
  - VITE_ENVIRONMENT
end note

:Upload to S3 + CloudFront;
note right
  SST StaticSite handles:
  - S3 sync
  - CloudFront invalidation
  - Cache headers
end note

:Run Smoke Tests;
note right
  - Health check: /api/health
  - Version: /api/version
end note

if (Tests Pass?) then (yes)
    :Deployment Success;
    :Output URLs;
    note right
      webUrl: https://xxx.cloudfront.net
      apiUrl: https://xxx.lambda-url...
    end note
    |Developer|
    :Access CloudFront URL;
    note right
      Status bar shows:
      [STAGE] time v1.0.5
    end note
else (no)
    :Deployment Failed;
    |Developer|
    :Review SST Logs;
    note right
      .sst/log/sst.log
      SST Console
    end note
endif

stop

@enduml
