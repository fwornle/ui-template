name: Deploy

on:
  push:
    branches: ['**']  # Any branch triggers dev, main triggers int
    tags: ['v*']      # Tags trigger prod
    paths-ignore:
      - 'docs-content/**'
      - 'mkdocs.yml'
      - '*.md'
      - '.github/workflows/deploy-docs.yml'
  workflow_dispatch:
    inputs:
      stage:
        description: 'Stage to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - int
          - prod

env:
  NODE_VERSION: '20'
  AWS_REGION: 'eu-central-1'

jobs:
  determine-stage:
    name: Determine Deployment Stage
    runs-on: ubuntu-latest
    outputs:
      stage: ${{ steps.stage.outputs.stage }}
      is_production: ${{ steps.stage.outputs.is_production }}
    steps:
      - name: Determine stage
        id: stage
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual trigger - use selected stage
            STAGE="${{ github.event.inputs.stage }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Tagged release - deploy to prod
            STAGE="prod"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Push to main - deploy to int (staging)
            STAGE="int"
          else
            # Any other branch - deploy to dev
            STAGE="dev"
          fi

          echo "stage=$STAGE" >> $GITHUB_OUTPUT
          echo "is_production=$([[ $STAGE == 'prod' ]] && echo true || echo false)" >> $GITHUB_OUTPUT

          echo "Deploying to stage: $STAGE"

  deploy:
    name: Deploy with SST
    runs-on: ubuntu-latest
    needs: determine-stage
    # Environment provides:
    # 1. Protection rules (required reviewers for int/prod)
    # 2. Environment-specific secrets (AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY)
    # 3. Deployment history tracking
    environment:
      name: ${{ needs.determine-stage.outputs.stage }}
      url: ${{ steps.outputs.outputs.web_url }}
    outputs:
      web_url: ${{ steps.outputs.outputs.web_url }}
      api_url: ${{ steps.outputs.outputs.api_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Secrets are pulled from the environment (dev/int/prod)
          # This allows different AWS accounts per environment
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: npm ci

      - name: Deploy with SST
        id: deploy
        run: |
          STAGE="${{ needs.determine-stage.outputs.stage }}"
          echo "Deploying to stage: $STAGE"

          # Deploy with SST and capture output
          npx sst deploy --stage $STAGE 2>&1 | tee deploy-output.txt

          # Parse outputs from SST
          echo "Parsing SST outputs..."

      - name: Get deployment outputs
        id: outputs
        run: |
          STAGE="${{ needs.determine-stage.outputs.stage }}"

          # Get outputs using SST CLI or from state
          # SST stores outputs in .sst directory after deploy
          WEB_URL=$(grep -oP 'webUrl:\s*\K\S+' deploy-output.txt || echo "")
          API_URL=$(grep -oP 'apiUrl:\s*\K\S+' deploy-output.txt || echo "")

          # Fallback: query from SST outputs if grep failed
          if [[ -z "$WEB_URL" ]]; then
            WEB_URL=$(grep -oP 'Web:\s*\K\S+' deploy-output.txt || echo "")
          fi
          if [[ -z "$API_URL" ]]; then
            API_URL=$(grep -oP 'Api:\s*\K\S+' deploy-output.txt || echo "")
          fi

          echo "Web URL: $WEB_URL"
          echo "API URL: $API_URL"

          echo "web_url=$WEB_URL" >> $GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [determine-stage, deploy]
    steps:
      - name: Run health checks
        run: |
          API_URL="${{ needs.deploy.outputs.api_url }}"

          if [[ -z "$API_URL" ]]; then
            echo "Warning: API URL not available, skipping health checks"
            exit 0
          fi

          echo "Testing API health endpoint..."
          response=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}api/health" || echo "000")
          if [[ "$response" == "200" ]]; then
            echo "API health check passed"
          else
            echo "API health check returned status $response"
          fi

          echo "Testing API version endpoint..."
          curl -s "${API_URL}api/version" | jq . || echo "Version endpoint response received"

  notify-deployment:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [determine-stage, deploy, smoke-tests]
    if: always()
    steps:
      - name: Determine deployment status
        id: status
        run: |
          if [[ "${{ needs.smoke-tests.result }}" == "success" || "${{ needs.smoke-tests.result }}" == "skipped" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=Deployment to ${{ needs.determine-stage.outputs.stage }} successful!" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Deployment to ${{ needs.determine-stage.outputs.stage }} failed!" >> $GITHUB_OUTPUT
          fi

      - name: Create summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Stage** | ${{ needs.determine-stage.outputs.stage }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ steps.status.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Web URL** | ${{ needs.deploy.outputs.web_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **API URL** | ${{ needs.deploy.outputs.api_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SST Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- Cognito User Pool" >> $GITHUB_STEP_SUMMARY
          echo "- Lambda Function URL" >> $GITHUB_STEP_SUMMARY
          echo "- S3 Static Site" >> $GITHUB_STEP_SUMMARY
          echo "- CloudFront CDN" >> $GITHUB_STEP_SUMMARY
