name: Deploy

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - int
          - prod

env:
  NODE_VERSION: '20'
  AWS_REGION: 'eu-central-1'

jobs:
  determine-environment:
    name: Determine Deployment Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      is_production: ${{ steps.env.outputs.is_production }}
      tag: ${{ steps.env.outputs.tag }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            ENV="prod"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="int"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            ENV="dev"
          else
            ENV="dev"
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "is_production=$([[ $ENV == 'prod' ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

          echo "Deploying to: $ENV"

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: determine-environment
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"
          STACK_NAME="ui-template-$ENV"

          # Try to get existing stack outputs, or use defaults for first deployment
          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" 2>/dev/null; then
            echo "=== Getting configuration from existing stack $STACK_NAME ==="
            USER_POOL_ID=$(aws cloudformation describe-stacks \
              --stack-name "$STACK_NAME" \
              --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' \
              --output text 2>/dev/null || echo "")

            USER_POOL_CLIENT_ID=$(aws cloudformation describe-stacks \
              --stack-name "$STACK_NAME" \
              --query 'Stacks[0].Outputs[?OutputKey==`UserPoolClientId`].OutputValue' \
              --output text 2>/dev/null || echo "")

            API_URL=$(aws cloudformation describe-stacks \
              --stack-name "$STACK_NAME" \
              --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
              --output text 2>/dev/null || echo "")
          else
            echo "=== First deployment - using placeholder values ==="
            USER_POOL_ID=""
            USER_POOL_CLIENT_ID=""
            API_URL=""
          fi

          # Create .env file for frontend build
          cat > .env << EOF
          VITE_COGNITO_USER_POOL_ID=$USER_POOL_ID
          VITE_COGNITO_USER_POOL_CLIENT_ID=$USER_POOL_CLIENT_ID
          VITE_COGNITO_REGION=eu-central-1
          VITE_API_URL=$API_URL
          VITE_ENVIRONMENT=$ENV
          EOF

          echo "=== Frontend .env configuration ==="
          cat .env

          echo "=== Building frontend ==="
          npm run build
          echo "Frontend build completed"

      - name: Install Lambda dependencies
        run: |
          cd lambda/api
          npm ci

      - name: SAM build
        run: sam build

      - name: Package application
        run: |
          TAG="${{ needs.determine-environment.outputs.tag }}"

          # Package SAM application
          sam package \
            --template-file .aws-sam/build/template.yaml \
            --output-template-file packaged-template.yaml \
            --resolve-s3 \
            --s3-prefix "ui-template-$TAG"

          # Package frontend
          cd dist
          zip -r ../frontend-$TAG.zip .
          cd ..

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ needs.determine-environment.outputs.tag }}
          path: |
            packaged-template.yaml
            frontend-*.zip
            .aws-sam/build/

  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [determine-environment, build]
    environment: ${{ needs.determine-environment.outputs.environment }}
    outputs:
      frontend_bucket: ${{ steps.outputs.outputs.frontend_bucket }}
      api_url: ${{ steps.outputs.outputs.api_url }}
      cloudfront_id: ${{ steps.outputs.outputs.cloudfront_id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ needs.determine-environment.outputs.tag }}

      - name: Install SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Deploy infrastructure
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"

          sam deploy \
            --template-file packaged-template.yaml \
            --stack-name ui-template-$ENV \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              Environment=$ENV \
            --no-fail-on-empty-changeset \
            --config-file samconfig.toml \
            --config-env $ENV \
            --region eu-central-1

      - name: Get deployment outputs
        id: outputs
        run: |
          STACK_NAME="ui-template-${{ needs.determine-environment.outputs.environment }}"

          echo "Getting outputs from stack: $STACK_NAME"

          API_URL=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
            --output text)

          FRONTEND_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query 'Stacks[0].Outputs[?OutputKey==`StaticWebsiteBucketName`].OutputValue' \
            --output text)

          CLOUDFRONT_ID=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' \
            --output text)

          CLOUDFRONT_URL=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontUrl`].OutputValue' \
            --output text)

          echo "API URL: $API_URL"
          echo "Frontend Bucket: $FRONTEND_BUCKET"
          echo "CloudFront ID: $CLOUDFRONT_ID"
          echo "CloudFront URL: $CLOUDFRONT_URL"

          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "frontend_bucket=$FRONTEND_BUCKET" >> $GITHUB_OUTPUT
          echo "cloudfront_id=$CLOUDFRONT_ID" >> $GITHUB_OUTPUT
          echo "cloudfront_url=$CLOUDFRONT_URL" >> $GITHUB_OUTPUT

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [determine-environment, build, deploy-infrastructure]
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ needs.determine-environment.outputs.tag }}

      - name: Extract frontend build
        run: |
          unzip frontend-${{ needs.determine-environment.outputs.tag }}.zip -d frontend-dist/

      - name: Deploy to S3
        run: |
          BUCKET="${{ needs.deploy-infrastructure.outputs.frontend_bucket }}"
          echo "Deploying to bucket: $BUCKET"

          # Deploy all files except index.html
          aws s3 sync frontend-dist/ s3://$BUCKET/ \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "index.html"

          # Deploy index.html with no-cache
          aws s3 cp frontend-dist/index.html s3://$BUCKET/index.html \
            --cache-control "no-cache" \
            --content-type "text/html"

      - name: Invalidate CloudFront cache
        run: |
          DISTRIBUTION_ID="${{ needs.deploy-infrastructure.outputs.cloudfront_id }}"

          if [[ -n "$DISTRIBUTION_ID" && "$DISTRIBUTION_ID" != "None" ]]; then
            echo "Invalidating CloudFront distribution: $DISTRIBUTION_ID"
            aws cloudfront create-invalidation \
              --distribution-id $DISTRIBUTION_ID \
              --paths "/*"
            echo "CloudFront cache invalidated"
          fi

  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy-infrastructure, deploy-frontend]
    environment: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - name: Run health checks
        run: |
          API_URL="${{ needs.deploy-infrastructure.outputs.api_url }}"

          echo "Testing API health endpoint..."
          response=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}api/health")
          if [[ "$response" == "200" ]]; then
            echo "API health check passed"
          else
            echo "API health check returned status $response"
          fi

          echo "Testing API version endpoint..."
          curl -s "${API_URL}api/version" | jq . || echo "Version endpoint response"

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy-infrastructure, deploy-frontend, smoke-tests]
    if: always()
    steps:
      - name: Determine deployment status
        id: status
        run: |
          if [[ "${{ needs.smoke-tests.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=Deployment to ${{ needs.determine-environment.outputs.environment }} successful!" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Deployment to ${{ needs.determine-environment.outputs.environment }} failed!" >> $GITHUB_OUTPUT
          fi

      - name: Create summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ steps.status.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL:** ${{ needs.deploy-infrastructure.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront URL:** ${{ needs.deploy-infrastructure.outputs.cloudfront_url }}" >> $GITHUB_STEP_SUMMARY
