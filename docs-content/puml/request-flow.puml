@startuml request-flow
!include _standard-style.puml

' AWS Icons for PlantUML v20.0 (2025)
!define AWSPuml https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v20.0/dist
!include AWSPuml/AWSCommon.puml
!include AWSPuml/NetworkingContentDelivery/CloudFront.puml
!include AWSPuml/NetworkingContentDelivery/APIGateway.puml
!include AWSPuml/Storage/SimpleStorageService.puml
!include AWSPuml/Compute/Lambda.puml
!include AWSPuml/ManagementGovernance/CloudWatch.puml
!include AWSPuml/General/User.puml

title UI Template - Request Flow

' Participants with AWS icons
participant "Browser" as browser
CloudFrontParticipant(cloudfront, "CloudFront", "")
SimpleStorageServiceParticipant(s3, "S3 Bucket", "")
APIGatewayParticipant(apigw, "API Gateway", "")
LambdaParticipant(lambda, "Lambda", "")
CloudWatchParticipant(cloudwatch, "CloudWatch", "")

== Initial Page Load ==

browser -> cloudfront : GET / (HTTPS)

alt Cache HIT
    cloudfront --> browser : HTML/JS/CSS (from edge cache)
else Cache MISS
    cloudfront -> s3 : GET /index.html
    s3 --> cloudfront : HTML content
    cloudfront -> cloudfront : Cache at edge
    cloudfront --> browser : HTML/JS/CSS
end

note right of cloudfront
  **CDN Behavior**
  - SPA routing: 404 -> index.html
  - Gzip compression
  - Cache-Control headers
end note

browser -> cloudfront : GET /assets/*.js, *.css
cloudfront --> browser : Static assets (cached)

== API Request Flow ==

browser -> cloudfront : GET /api/health
cloudfront -> apigw : Forward to API Gateway
apigw -> lambda : Invoke handler

lambda -> lambda : Route request
lambda -> cloudwatch : Log request start

alt Success
    lambda --> apigw : 200 OK + JSON
    apigw --> cloudfront : Response
    lambda -> cloudwatch : Log success
else Error
    lambda --> apigw : 4xx/5xx + Error JSON
    apigw --> cloudfront : Error response
    lambda -> cloudwatch : Log error with stack
end

cloudfront --> browser : Response

note right of apigw
  **API Gateway HTTP API**
  - Low latency, cost-effective
  - Built-in CORS support
  - Auto-scaling
end note

note right of lambda
  **Lambda Function**
  - Invoked by API Gateway
  - 30s timeout, 256MB memory
end note

== Protected API Request ==

browser -> cloudfront : GET /api/user/profile\n+ Authorization: Bearer <token>
cloudfront -> apigw : Forward with headers
apigw -> lambda : Invoke with auth headers

lambda -> lambda : Validate JWT token

alt Valid Token
    lambda -> lambda : Extract user from token
    lambda --> apigw : 200 OK + User data
    apigw --> cloudfront : Response
else Invalid/Expired Token
    lambda --> apigw : 401 Unauthorized
    apigw --> cloudfront : Auth error
end

cloudfront --> browser : Response

@enduml
