@startuml cicd-flow
!include _standard-style.puml

title CI/CD Deployment Flow (SST v3)

|Developer|
start
:Push Code or Tag;

|GitHub|
if (Trigger?) then (push to any branch)
    if (Branch?) then (main)
        :Trigger Deploy Workflow;
        :Stage = int;
        :Environment = int;
        note right
          Integration/Staging
          Auto-deploy
        end note
    else (other)
        :Trigger Deploy Workflow;
        :Stage = dev;
        :Environment = dev;
        note right
          Auto-deploy
          No approval required
        end note
    endif
else (tag v*)
    :Trigger Deploy Workflow;
    :Stage = prod;
    :Environment = prod;
    note right
      Protected environment
      Requires approval
    end note
endif

|GitHub Actions|
:Checkout Code;
:Setup Node.js 20;
:Configure AWS Credentials;
note right
  From environment secrets:
  AWS_ACCESS_KEY_ID
  AWS_SECRET_ACCESS_KEY
end note

if (Environment Protected?) then (prod)
    |Developer|
    :Review Deployment Request;
    :Approve or Reject;
    if (Approved?) then (yes)
        |GitHub Actions|
    else (no)
        :Deployment Cancelled;
        stop
    endif
else (dev/int)
endif

|GitHub Actions|
:Install Dependencies;
:Read Version from package.json;

:SST Deploy;
note right
  npx sst deploy --stage $STAGE

  SST handles:
  - Cognito User Pool
  - Lambda Function URL
  - S3 Static Site
  - CloudFront CDN
  - Environment injection
end note

:Build Frontend;
note right
  SST injects at build time:
  - VITE_API_URL
  - VITE_COGNITO_USER_POOL_ID
  - VITE_COGNITO_USER_POOL_CLIENT_ID
  - VITE_ENVIRONMENT
end note

:Upload to S3 + CloudFront;

:Run Smoke Tests;
note right
  - Health check: /api/health
  - Version: /api/version
end note

if (Tests Pass?) then (yes)
    :Deployment Success;
    :Output URLs;
    note right
      webUrl: https://xxx.cloudfront.net
      apiUrl: https://xxx.lambda-url...
    end note
    |Developer|
    :Access CloudFront URL;
else (no)
    :Deployment Failed;
    |Developer|
    :Review SST Logs;
endif

stop

@enduml
